"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[351],{8655:(I,C,d)=>{d.d(C,{V:()=>M});var f=d(177),e=d(5239),c=d(3953);const u=P=>({transform:P});function O(P,D){if(1&P&&(c.j41(0,"ion-text")(1,"p"),c.EFF(2),c.k0s()()),2&P){const E=c.XpG();c.R7$(2),c.JRh(E.model.subTitle)}}let M=(()=>{var P;class D{constructor(){this.fontSize="18rem",this.isMargin="translateY(10vh)"}ngOnInit(){}}return(P=D).\u0275fac=function(b){return new(b||P)},P.\u0275cmp=c.VBU({type:P,selectors:[["app-empty-screen"]],inputs:{model:"model",fontSize:"fontSize",isMargin:"isMargin"},standalone:!0,features:[c.aNF],decls:9,vars:9,consts:[[3,"ngStyle"],[1,"ion-text-center"],[3,"name","color"],[4,"ngIf"]],template:function(b,S){1&b&&(c.j41(0,"ion-grid",0)(1,"ion-row")(2,"ion-col",1),c.nrm(3,"ion-icon",2),c.k0s()(),c.j41(4,"ion-row")(5,"ion-col",1)(6,"ion-label"),c.EFF(7),c.k0s(),c.DNE(8,O,3,1,"ion-text",3),c.k0s()()()),2&b&&(c.Y8G("ngStyle",c.eq3(7,u,S.model.noSpace?"0vh":S.isMargin)),c.R7$(3),c.xc7("font-size",S.fontSize),c.Y8G("name",S.model.icon)("color",S.model.color?S.model.color:"tertiary"),c.R7$(4),c.SpI(" ",S.model.title," "),c.R7$(),c.Y8G("ngIf",null==S.model?null:S.model.subTitle))},dependencies:[e.lO,e.ln,e.hU,e.iq,e.he,e.IO,f.bT,f.B3]}),D})()},7351:(I,C,d)=>{d.r(C),d.d(C,{StudentsPage:()=>p});var f=d(467),e=d(3953),c=d(9384),u=d(5239),O=d(8655),M=d(1583),P=d(3202),D=d(177),E=d(9685),b=d(5079),S=d(5873);const i=l=>["/","tabs","students",l];function o(l,s){if(1&l&&(e.j41(0,"ion-text",13),e.EFF(1),e.nI1(2,"date"),e.k0s()),2&l){const r=e.XpG().$implicit;e.R7$(),e.SpI(" ",e.i5U(2,1,null==r||null==r.gym_plan?null:r.gym_plan.expiry_date,"MMM d, y")," ")}}function n(l,s){1&l&&(e.j41(0,"ion-text",13),e.EFF(1," - "),e.k0s())}function t(l,s){if(1&l&&(e.j41(0,"ion-text",13),e.EFF(1),e.nI1(2,"date"),e.k0s()),2&l){const r=e.XpG().$implicit;e.R7$(),e.SpI(" ",e.i5U(2,1,null==r||null==r.pt_plan?null:r.pt_plan.expiry_date,"MMM d, y")," ")}}function _(l,s){1&l&&(e.j41(0,"ion-text",13),e.EFF(1," - "),e.k0s())}function h(l,s){if(1&l&&(e.j41(0,"ion-card",8)(1,"ion-item",10)(2,"ion-thumbnail",11),e.nrm(3,"ion-img",12),e.k0s(),e.j41(4,"ion-label"),e.EFF(5),e.j41(6,"p")(7,"ion-text",13),e.EFF(8),e.k0s()(),e.j41(9,"p"),e.EFF(10),e.nI1(11,"timestampToDate"),e.nI1(12,"date"),e.k0s()()(),e.j41(13,"ion-row",14)(14,"ion-col",15)(15,"div",16)(16,"ion-label"),e.EFF(17,"Gender"),e.k0s(),e.j41(18,"p")(19,"ion-text",13),e.EFF(20),e.k0s()()()(),e.j41(21,"ion-col",15)(22,"div",16)(23,"ion-label"),e.EFF(24,"Plan Expiry"),e.k0s(),e.j41(25,"p"),e.DNE(26,o,3,4,"ion-text",13)(27,n,2,0,"ion-text",13),e.k0s()()(),e.j41(28,"ion-col",15)(29,"div",16)(30,"ion-label"),e.EFF(31,"PT Plan Expiry"),e.k0s(),e.j41(32,"p"),e.DNE(33,t,3,4,"ion-text",13)(34,_,2,0,"ion-text",13),e.k0s()()()()()),2&l){const r=s.$implicit;e.Y8G("routerLink",e.eq3(14,i,null==r?null:r.id)),e.R7$(),e.Y8G("detail",!0),e.R7$(2),e.Y8G("src",null==r?null:r.photo),e.R7$(2),e.SpI(" ",(null==r?null:r.name)+" ("+(null==r?null:r.serial_no)+")"," "),e.R7$(3),e.JRh(null==r?null:r.phone),e.R7$(2),e.SpI(" Joined on ",e.i5U(12,11,e.bMT(11,9,null==r?null:r.created_at),"MMM d, y")," "),e.R7$(10),e.JRh(null==r?null:r.gender),e.R7$(6),e.vxM(null!=r&&r.gym_plan?26:27),e.R7$(7),e.vxM(null!=r&&r.pt_plan?33:34)}}function g(l,s){if(1&l){const r=e.RV6();e.j41(0,"ion-list"),e.Z7z(1,h,35,16,"ion-card",8,e.Vm6),e.k0s(),e.j41(3,"ion-infinite-scroll",9),e.bIt("ionInfinite",function(v){e.eBV(r);const y=e.XpG();return e.Njj(y.loadMoreStudents(v))}),e.nrm(4,"ion-infinite-scroll-content"),e.k0s()}if(2&l){const r=e.XpG();e.R7$(),e.Dyx(r.students)}}function m(l,s){if(1&l&&e.nrm(0,"app-empty-screen",7),2&l){const r=e.XpG();e.Y8G("model",r.emptyModel)}}let p=(()=>{var l;class s{constructor(){this.noMore=!1,this.students=[],this.emptyModel={title:"No members registered yet",icon:"people-outline"},this.global=(0,e.WQX)(P.d),this.customerService=(0,e.WQX)(M.m),(0,b.a)({personAdd:S.FFT,peopleOutline:S.wx_})}ngOnInit(){this.getData(),this.studentsSub=this.customerService.students.subscribe({next:a=>{console.log("students data: ",a),this.students=a},error:a=>{console.log(a)}})}getData(){var a=this;return(0,f.A)(function*(){try{var v;a.global.showLoader();let y=null;a.query&&(null===(v=a.query)||void 0===v||null===(v=v.trim())||void 0===v?void 0:v.length)>0&&(y=a.query);const x=yield a.customerService.getStudents(10,y);console.log(x),(null==x?void 0:x.length)<10&&(a.noMore=!0),a.global.hideLoader()}catch(y){a.global.hideLoader(),console.log(y),a.global.checkMessageForErrorToast(y)}})()}loadMoreStudents(a){var v=this;return(0,f.A)(function*(){try{console.log(a);const y=yield v.customerService.getStudents(10,v.query,!0);console.log(y),(null==y?void 0:y.length)<10&&(v.noMore=!0),console.log("no more students: ",v.noMore),setTimeout(()=>{a.target.complete()},500)}catch(y){console.log(y),v.global.checkMessageForErrorToast(y)}})()}onSearchChange(a){console.log(a.detail.value),this.query=a.detail.value.toLowerCase(),this.querySearch()}querySearch(){var a;(this.query&&(null===(a=this.query)||void 0===a||null===(a=a.trim())||void 0===a?void 0:a.length)>0||!this.query)&&this.getData()}ngOnDestroy(){this.studentsSub&&this.studentsSub.unsubscribe()}}return(l=s).\u0275fac=function(a){return new(a||l)},l.\u0275cmp=e.VBU({type:l,selectors:[["app-students"]],standalone:!0,features:[e.aNF],decls:13,vars:1,consts:[["searchInput",""],["color","secondary"],["slot","end"],["routerLink","/tabs/student-register","color","primary"],["name","person-add"],["debounce","800","mode","ios","placeholder","Search members...",1,"srchBar",3,"ionInput"],["color","light"],[3,"model"],[3,"routerLink"],[3,"ionInfinite"],[3,"detail"],["slot","start"],[3,"src"],["color","dark"],[1,"ion-margin-vertical"],["size","4"],["align","center"]],template:function(a,v){if(1&a){const y=e.RV6();e.j41(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-title"),e.EFF(3,"Members"),e.k0s(),e.j41(4,"ion-buttons",2)(5,"ion-button",3),e.nrm(6,"ion-icon",4),e.k0s()()(),e.j41(7,"ion-toolbar",1)(8,"ion-searchbar",5,0),e.bIt("ionInput",function(T){return e.eBV(y),e.Njj(v.onSearchChange(T))}),e.k0s()()(),e.j41(10,"ion-content",6),e.DNE(11,g,5,0)(12,m,1,1,"app-empty-screen",7),e.k0s()}2&a&&(e.R7$(11),e.vxM(v.students.length>0?11:12))},dependencies:[u.S1,u.hU,u.ln,u.IO,u.b_,u.Hp,u.Ax,u.he,u.KW,u.Zx,u.uz,u.nf,u.iq,u.QW,u.Jm,u.W9,u.eU,u.BC,u.ai,c.Wk,D.vh,O.V,E.i],styles:["ion-list[_ngcontent-%COMP%]{background:transparent}ion-list[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]{--border-radius: 8px;border:1px solid var(--ion-color-primary);padding:.3rem .1rem}ion-list[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-size:1rem;font-weight:700}ion-list[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.85rem;margin-top:5px;font-weight:400}ion-list[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-thumbnail[_ngcontent-%COMP%]{width:4rem;height:4rem}ion-list[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-thumbnail[_ngcontent-%COMP%]   ion-img[_ngcontent-%COMP%]{height:100%;width:100%;border-radius:8px}ion-list[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]   ion-row[_ngcontent-%COMP%]   ion-col[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-size:.8rem;color:gray}ion-list[_ngcontent-%COMP%]   ion-card[_ngcontent-%COMP%]   ion-row[_ngcontent-%COMP%]   ion-col[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:5px 0;font-size:.9rem}"]}),s})()},9685:(I,C,d)=>{d.d(C,{i:()=>e});var f=d(3953);let e=(()=>{var c;class u{transform(M){return M?null!=M&&M.seconds?new Date(1e3*(M.seconds||0)+(M.nanoseconds||0)/1e6):M:null}}return(c=u).\u0275fac=function(M){return new(M||c)},c.\u0275pipe=f.EJ8({name:"timestampToDate",type:c,pure:!0,standalone:!0}),u})()},1583:(I,C,d)=>{d.d(C,{m:()=>D});var f=d(467),e=d(9642),c=d(3953),u=d(9967),O=d(4412),M=d(1985),P=d(1339);let D=(()=>{var E;class b{get registerForm(){return this._registerForm.asObservable()}get students(){return this._students.asObservable()}get member(){return this._member.asObservable()}constructor(){this.expiry_days_count=365,this._registerForm=new O.t(0),this._students=new O.t([]),this._member=new O.t(null),this.apiService=(0,c.WQX)(e.G),this.auth=(0,c.WQX)(P.u)}updateFormValue(i){this._registerForm.next(i)}uploadPhoto(i,o){var n=this;return(0,f.A)(function*(){try{const t=Date.now();console.log(o);const _=`students/${t}.${i.format}`;return yield n.apiService.uploadImage(o,_)}catch(t){throw t}})()}registerStudent(i,o,n){var t=this;return(0,f.A)(function*(){try{const _=t.apiService.collectionFirestoreRef("students"),h=(0,u.P)(_,(0,u.or)(t.apiService.whereQuery("email","==",null==i?void 0:i.email),t.apiService.whereQuery("phone","==",null==i?void 0:i.phone))),m=yield(yield t.apiService.getDocsByQuery(h)).docs.map(a=>a.data());if((null==m?void 0:m.length)>0)throw{code:"exists",message:"Student already registered with same email or phone number"};const p=yield t.uploadPhoto(o,n),l={...i,photo:p},s=yield t.apiService.addDocument("students",l);let r=[{...l,id:null==s?void 0:s.id},...t._students.value];return t._students.next(r),s}catch(_){throw _}})()}getStudents(i,o,n){var t=this;return(0,f.A)(function*(){try{if(!(yield t.auth.getId()))throw"Unauthorized user";n||(t.lastVisible=null);const h=t.apiService.collectionFirestoreRef("students");let g=(0,u.P)(h,t.apiService.orderByQuery("created_at","desc"),t.apiService.limitQuery(i));o&&(g=(0,u.P)(g,t.apiService.whereQuery("short_name",">=",o),t.apiService.whereQuery("short_name","<=",o+"\uf8ff"))),t.lastVisible&&n&&(g=(0,u.P)(g,t.apiService.startAfterQuery(t.lastVisible)));const m=yield t.apiService.getDocsByQuery(g);console.log(m);let p=[];m.docs.length>0&&(t.lastVisible=m.docs[m.docs.length-1],console.log("last",t.lastVisible),p=yield m.docs.map(s=>{let r=s.data();return r.id=s.id,r}));let l=[];return n?(console.log("orders",p),l=t._students.value||[],l=l.concat(p)):l=[...p],t._students.next(l),l}catch(_){throw _}})()}getStudentsCount(){var i=this;return(0,f.A)(function*(){try{return(yield i.apiService.getDocs("students")).size}catch(o){throw o}})()}getStudent(i){var o=this;return(0,f.A)(function*(){try{const n=yield o.apiService.getDocById(`students/${i}`);if(n.exists()){let t=n.data();return t.id=n.id,o._member.next(t),t}throw console.log("No such document!"),"No such document!"}catch(n){throw n}})()}updateMember(i,o,n,t){var _=this;return(0,f.A)(function*(){try{if(n){const p=yield _.uploadPhoto(n,t);o={...o,photo:p}}const h=yield _.apiService.updateDocument(`students/${i.id}`,o);console.log(h);let g=_._students.value||[];if(0==(null==g?void 0:g.length)){let p=_._member.value;return console.log("member data: ",p),p?(p={...p,...o},_._member.next(p),{...p,...o}):null}const m=g.findIndex(p=>p.id==i.id);return-1==m?null:(g[m]={...g[m],...o},_._students.next(g),_._member.next(g[m]),{...g[m]})}catch(h){throw h}})()}updateMemberValue(i,o=!0){const n=this._students.value;let t;if((null==n?void 0:n.length)>0){const _=n.findIndex(h=>h.id==(null==i?void 0:i.id));if(-1==_)return;n[_]={...n[_],...i},this._students.next(n),t=n[_]}else{if(t=this._member.value,!t)return;t={...t,...i}}o&&this._member.next(t)}updateMemberData(i,o){const n=this._students.value;let t;if(0==(null==n?void 0:n.length)){if(t=this._member.value,!t)return}else t=n.find(h=>h.id==i);const _={...t,...o};this._member.next(_),this.updateMemberValue(_,!1)}resetMember(){this._member.next(null)}getMemberData(i){var o=this;return(0,f.A)(function*(){try{let n=o._member.value;return n||(n=yield o.getStudent(i)),n}catch(n){throw n}})()}fetchMembersWithExpiringPlans(){return new M.c(i=>{const o=(new Date).toISOString(),n=new Date;n.setDate(n.getDate()+this.expiry_days_count);const t=n.toISOString(),_=this.apiService.collectionFirestoreRef("students"),h=(0,u.P)(_,this.apiService.whereQuery("gym_plan.expiry_date","<=",t),this.apiService.whereQuery("pt_plan.expiry_date","<=",t));return(0,u.aQ)(h,m=>{const p=[];m.docs.forEach(l=>{const s=l.data(),r=l.id,a=[];null!=s&&s.gym_plan&&s.gym_plan.expiry_date>=o&&s.gym_plan.expiry_date<=t&&a.push("GYM"),null!=s&&s.pt_plan&&(s.pt_plan.expiry_date>=o&&s.pt_plan.expiry_date<=t||s.pt_plan.sessions-s.pt_plan.sessions_used==0)&&a.push("PT"),a.length>0&&p.push({id:r,...s,expiringPlans:a})}),console.log(p),i.next(p)},m=>i.error(m))})}fetchMembersWithExpiredGymPlans(){var i=this;return(0,f.A)(function*(){try{const o=(new Date).toISOString(),n=i.apiService.collectionFirestoreRef("students"),t=(0,u.P)(n,i.apiService.whereQuery("gym_plan.expiry_date","<",o)),_=yield i.apiService.getDocsByQuery(t),h=[];return _.forEach(g=>{const m=g.data();h.push({id:g.id,...m})}),console.log(h),h}catch(o){throw console.error(o),o}})()}fetchMembersWithExpiredOrUsedUpPTPlans(){var i=this;return(0,f.A)(function*(){try{const o=(new Date).toISOString(),n=i.apiService.collectionFirestoreRef("students"),t=(0,u.P)(n,i.apiService.whereQuery("pt_plan.expiry_date","<=",o),i.apiService.whereQuery("pt_plan.sessions",">=",0)),_=yield i.apiService.getDocsByQuery(t),h=[];return _.forEach(g=>{var m,p,l;const s=g.data();(null==s?void 0:s.pt_plan)&&((null==s||null===(m=s.pt_plan)||void 0===m?void 0:m.expiry_date)<=o||(null==s||null===(p=s.pt_plan)||void 0===p?void 0:p.sessions)-(null==s||null===(l=s.pt_plan)||void 0===l?void 0:l.sessions_used)==0)&&h.push({id:g.id,...s})}),console.log(h),h}catch(o){throw console.error(o),o}})()}getDaysLeft(i){const o=new Date(i),n=new Date;o.setHours(0,0,0,0),n.setHours(0,0,0,0);const t=new Date;if(t.setDate(n.getDate()+this.expiry_days_count),n<=o&&o<=t){const _=o.getTime()-n.getTime();return Math.ceil(_/864e5)}return null}}return(E=b).\u0275fac=function(i){return new(i||E)},E.\u0275prov=c.jDH({token:E,factory:E.\u0275fac,providedIn:"root"}),b})()}}]);